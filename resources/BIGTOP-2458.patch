From dba76ee751de9041a03c69d896a3038898664196 Mon Sep 17 00:00:00 2001
From: Cory Johns <johnsca@gmail.com>
Date: Thu, 26 May 2016 15:34:49 -0400
Subject: [PATCH] BIGTOP-2458: Add option to disable IP hostname checking for
 DataNode registration

---
 bigtop-deploy/puppet/hieradata/bigtop/cluster.yaml          | 1 +
 bigtop-deploy/puppet/modules/hadoop/manifests/init.pp       | 1 +
 bigtop-deploy/puppet/modules/hadoop/templates/hdfs-site.xml | 5 +++++
 3 files changed, 7 insertions(+)

diff --git a/bigtop-deploy/puppet/hieradata/bigtop/cluster.yaml b/bigtop-deploy/puppet/hieradata/bigtop/cluster.yaml
index f592f64..aeed4b8 100644
--- a/bigtop-deploy/puppet/hieradata/bigtop/cluster.yaml
+++ b/bigtop-deploy/puppet/hieradata/bigtop/cluster.yaml
@@ -83,6 +83,7 @@ hadoop::kerberos_realm: "%{hiera('kerberos::site::realm')}"
 hadoop::common_hdfs::hadoop_namenode_host: "%{hiera('bigtop::hadoop_head_node')}"
 # actually default but needed for hadoop_namenode_uri here
 hadoop::common_hdfs::hadoop_namenode_port: "8020"
+hadoop::common_hdfs::namenode_datanode_registration_ip_hostname_check: true
 
 # Set as shown below in site.yaml to also enable Kerberos authentication
 # on the web GUIs of journalnode, namenode, datanode, resourcemanager and
diff --git a/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp b/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp
index 90c9505..d2bae12 100644
--- a/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp
+++ b/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp
@@ -228,6 +228,7 @@
       $hadoop_http_authentication_signature_secret_file = "/etc/hadoop/conf/hadoop-http-authentication-signature-secret",
       $hadoop_http_authentication_cookie_domain = regsubst($fqdn, "^[^\\.]+\\.", ""),
       $generate_secrets = $hadoop::generate_secrets,
+      $namenode_datanode_registration_ip_hostname_check,
   ) inherits hadoop {
 
     $sshfence_keydir  = "$hadoop_ha_sshfence_user_home/.ssh"
diff --git a/bigtop-deploy/puppet/modules/hadoop/templates/hdfs-site.xml b/bigtop-deploy/puppet/modules/hadoop/templates/hdfs-site.xml
index 328cf6f..9dce36a 100644
--- a/bigtop-deploy/puppet/modules/hadoop/templates/hdfs-site.xml
+++ b/bigtop-deploy/puppet/modules/hadoop/templates/hdfs-site.xml
@@ -297,4 +297,9 @@
 
 <%   end -%>
 <% end -%>
+
+  <property>
+    <name>dfs.namenode.datanode.registration.ip-hostname-check</name>
+    <value><%= @namenode_datanode_registration_ip_hostname_check %></value>
+  </property>
 </configuration>
